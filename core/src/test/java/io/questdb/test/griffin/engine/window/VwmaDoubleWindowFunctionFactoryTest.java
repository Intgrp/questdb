/*******************************************************************************
 *     ___                  _   ____  ____
 *    / _ \ _   _  ___  ___| |_|  _ \| __ )
 *   | | | | | | |/ _ \/ __| __| | | |  _ \
 *   | |_| | |_| |  __/\__ \ |_| |_| | |_) |
 *    \__\_\\__,_|\___||___/\__|____/|____/
 *
 *  Copyright (c) 2014-2019 Appsicle
 *  Copyright (c) 2019-2024 QuestDB
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 ******************************************************************************/

package io.questdb.test.griffin.engine.window;

import io.questdb.test.AbstractCairoTest;
import org.junit.Test;

public class VwmaDoubleWindowFunctionFactoryTest extends AbstractCairoTest {
    public static String DDL = "CREATE TABLE 'trades' (\n" +
            "  symbol SYMBOL capacity 256 CACHE,\n" +
            "  side SYMBOL capacity 256 CACHE,\n" +
            "  price DOUBLE,\n" +
            "  amount DOUBLE,\n" +
            "  timestamp TIMESTAMP\n" +
            ") timestamp (timestamp) PARTITION BY DAY WAL;";

    public static String INSERT = "INSERT INTO trades (symbol, side, price, amount, timestamp) values " +
            "('ETH-USD','sell',2615.54,'4.4E-4','2022-03-08T18:03:57.609765Z'),\n" +
            "('ETH-USD','buy',2615.4,'0.002','2022-03-08T18:03:57.764098Z'),\n" +
            "('ETH-USD','buy',2615.4,'0.001','2022-03-08T18:03:57.764098Z'),\n" +
            "('ETH-USD','buy',2615.4,'4.2698000000000004E-4','2022-03-08T18:03:57.764098Z'),\n" +
            "('ETH-USD','buy',2615.36,'0.02593599','2022-03-08T18:03:58.194582Z'),\n" +
            "('ETH-USD','buy',2615.37,'0.03500836','2022-03-08T18:03:58.194582Z'),\n" +
            "('ETH-USD','buy',2615.46,'0.17260246','2022-03-08T18:03:58.194582Z'),\n" +
            "('ETH-USD','buy',2615.47,'0.14810976','2022-03-08T18:03:58.194582Z'),\n" +
            "('ETH-USD','buy',2615.35,'0.02245868','2022-03-08T18:03:58.612275Z'),\n" +
            "('ETH-USD','buy',2615.36,'0.03244613','2022-03-08T18:03:58.612275Z'),\n" +
            "('ETH-USD','buy',2615.62,'4.4E-4','2022-03-08T18:03:58.682070Z'),\n" +
            "('ETH-USD','buy',2615.62,'4.4E-4','2022-03-08T18:03:58.682070Z'),\n" +
            "('ETH-USD','buy',2615.62,'4.4E-4','2022-03-08T18:03:58.682070Z'),\n" +
            "('ETH-USD','buy',2615.62,'4.4E-4','2022-03-08T18:03:58.682070Z'),\n" +
            "('ETH-USD','buy',2615.62,'0.02685107','2022-03-08T18:03:58.682070Z'),\n" +
            "('ETH-USD','buy',2615.63,'0.00828692','2022-03-08T18:03:58.682070Z'),\n" +
            "('ETH-USD','sell',2615.43,'4.4E-4','2022-03-08T18:03:59.093929Z'),\n" +
            "('ETH-USD','sell',2615.43,'4.4E-4','2022-03-08T18:03:59.093929Z'),\n" +
            "('ETH-USD','sell',2615.38,'4.4E-4','2022-03-08T18:03:59.093929Z'),\n" +
            "('ETH-USD','sell',2615.36,'4.4E-4','2022-03-08T18:03:59.093929Z'),\n" +
            "('ETH-USD','sell',2615.08,'0.01824','2022-03-08T18:03:59.093929Z'),\n" +
            "('ETH-USD','buy',2615.45,'0.001','2022-03-08T18:03:59.608328Z'),\n" +
            "('ETH-USD','buy',2615.45,'0.0440829','2022-03-08T18:03:59.608328Z'),\n" +
            "('ETH-USD','buy',2615.46,'4.4E-4','2022-03-08T18:03:59.608328Z'),\n" +
            "('ETH-USD','buy',2615.55,'4.4E-4','2022-03-08T18:03:59.608328Z'),\n" +
            "('ETH-USD','buy',2615.55,'4.4E-4','2022-03-08T18:03:59.608328Z'),\n" +
            "('ETH-USD','buy',2615.55,'4.4E-4','2022-03-08T18:03:59.608328Z'),\n" +
            "('ETH-USD','buy',2615.56,'7.011200000000001E-4','2022-03-08T18:03:59.608328Z'),\n" +
            "('ETH-USD','buy',2615.44,'4.4E-4','2022-03-08T18:03:59.727709Z'),\n" +
            "('ETH-USD','buy',2615.46,'0.00556635','2022-03-08T18:03:59.727709Z'),\n" +
            "('ETH-USD','buy',2615.49,'0.001','2022-03-08T18:04:00.286031Z'),\n" +
            "('ETH-USD','buy',2615.5,'4.4E-4','2022-03-08T18:04:00.286031Z'),\n" +
            "('ETH-USD','buy',2615.5,'4.4E-4','2022-03-08T18:04:00.286031Z'),\n" +
            "('ETH-USD','buy',2615.5,'4.4E-4','2022-03-08T18:04:00.286031Z'),\n" +
            "('ETH-USD','buy',2615.5,'4.4E-4','2022-03-08T18:04:00.286031Z'),\n" +
            "('ETH-USD','buy',2615.51,'0.03560969','2022-03-08T18:04:00.286031Z'),\n" +
            "('ETH-USD','buy',2615.52,'0.03448545','2022-03-08T18:04:00.286031Z'),\n" +
            "('ETH-USD','buy',2615.66,'0.05214486','2022-03-08T18:04:00.286031Z'),\n" +
            "('ETH-USD','sell',2615.46,'0.05398012','2022-03-08T18:04:00.326210Z'),\n" +
            "('ETH-USD','sell',2615.47,'0.001','2022-03-08T18:04:00.399099Z'),\n" +
            "('ETH-USD','sell',2615.47,'0.001','2022-03-08T18:04:00.399099Z'),\n" +
            "('ETH-USD','sell',2615.46,'0.20830946','2022-03-08T18:04:00.399099Z'),\n" +
            "('ETH-USD','buy',2615.48,'0.00283596','2022-03-08T18:04:00.431068Z'),\n" +
            "('ETH-USD','buy',2615.48,'4.4E-4','2022-03-08T18:04:00.769190Z'),\n" +
            "('ETH-USD','buy',2615.49,'4.4E-4','2022-03-08T18:04:00.769190Z'),\n" +
            "('ETH-USD','buy',2615.49,'4.4E-4','2022-03-08T18:04:00.769190Z'),\n" +
            "('ETH-USD','buy',2615.49,'4.4E-4','2022-03-08T18:04:00.769190Z'),\n" +
            "('ETH-USD','buy',2615.5,'0.03845952','2022-03-08T18:04:00.769190Z'),\n" +
            "('ETH-USD','buy',2615.52,'4.4E-4','2022-03-08T18:04:00.825881Z'),\n" +
            "('ETH-USD','buy',2615.52,'4.4E-4','2022-03-08T18:04:00.825881Z'),\n" +
            "('ETH-USD','buy',2615.66,'4.4E-4','2022-03-08T18:04:00.826507Z'),\n" +
            "('ETH-USD','buy',2615.66,'4.4E-4','2022-03-08T18:04:00.826507Z'),\n" +
            "('ETH-USD','buy',2615.67,'0.57','2022-03-08T18:04:00.826507Z'),\n" +
            "('ETH-USD','buy',2616.22,'0.47912','2022-03-08T18:04:00.826507Z'),\n" +
            "('ETH-USD','buy',2615.66,'4.4E-4','2022-03-08T18:04:01.004211Z'),\n" +
            "('ETH-USD','buy',2615.66,'4.4E-4','2022-03-08T18:04:01.004211Z'),\n" +
            "('ETH-USD','buy',2615.66,'4.4E-4','2022-03-08T18:04:01.004211Z'),\n" +
            "('ETH-USD','sell',2615.95,'0.001','2022-03-08T18:04:01.783673Z'),\n" +
            "('ETH-USD','sell',2615.95,'0.001','2022-03-08T18:04:01.783673Z'),\n" +
            "('ETH-USD','sell',2615.8,'0.018','2022-03-08T18:04:01.783673Z'),\n" +
            "('ETH-USD','buy',2616.08,'0.001','2022-03-08T18:04:01.787719Z'),\n" +
            "('ETH-USD','buy',2616.09,'0.001','2022-03-08T18:04:01.787719Z'),\n" +
            "('ETH-USD','buy',2616.1,'0.00732372','2022-03-08T18:04:01.787719Z'),\n" +
            "('ETH-USD','sell',2615.81,'0.001','2022-03-08T18:04:01.991343Z'),\n" +
            "('ETH-USD','sell',2615.81,'0.001','2022-03-08T18:04:01.991343Z'),\n" +
            "('ETH-USD','sell',2615.81,'0.001','2022-03-08T18:04:01.991343Z'),\n" +
            "('ETH-USD','sell',2615.77,'0.15516619','2022-03-08T18:04:01.991343Z'),\n" +
            "('ETH-USD','sell',2615.7,'0.12193348','2022-03-08T18:04:01.991343Z'),\n" +
            "('ETH-USD','sell',2615.69,'1.91228355','2022-03-08T18:04:01.991343Z'),\n" +
            "('ETH-USD','buy',2616.02,'0.001','2022-03-08T18:04:02.006053Z'),\n" +
            "('ETH-USD','buy',2616.02,'0.00318975','2022-03-08T18:04:02.006053Z'),\n" +
            "('ETH-USD','sell',2615.78,'0.001','2022-03-08T18:04:02.015785Z'),\n" +
            "('ETH-USD','buy',2615.86,'0.03803194','2022-03-08T18:04:02.120083Z'),\n" +
            "('ETH-USD','sell',2615.59,'0.001','2022-03-08T18:04:02.267540Z'),\n" +
            "('ETH-USD','sell',2615.59,'0.001','2022-03-08T18:04:02.267540Z'),\n" +
            "('ETH-USD','sell',2615.57,'4.4E-4','2022-03-08T18:04:02.267540Z'),\n" +
            "('ETH-USD','sell',2615.57,'4.4E-4','2022-03-08T18:04:02.267540Z'),\n" +
            "('ETH-USD','sell',2615.57,'4.4E-4','2022-03-08T18:04:02.267540Z'),\n" +
            "('ETH-USD','sell',2615.57,'4.4E-4','2022-03-08T18:04:02.267540Z'),\n" +
            "('ETH-USD','sell',2615.56,'0.00492536','2022-03-08T18:04:02.267540Z'),\n" +
            "('ETH-USD','buy',2615.59,'0.001','2022-03-08T18:04:03.048224Z'),\n" +
            "('ETH-USD','buy',2615.59,'9.075600000000001E-4','2022-03-08T18:04:03.048224Z'),\n" +
            "('ETH-USD','sell',2615.58,'0.001','2022-03-08T18:04:03.289441Z'),\n" +
            "('ETH-USD','sell',2615.58,'0.02127252','2022-03-08T18:04:03.289441Z'),\n" +
            "('ETH-USD','sell',2615.58,'4.4E-4','2022-03-08T18:04:03.289441Z'),\n" +
            "('ETH-USD','sell',2615.58,'4.4E-4','2022-03-08T18:04:03.289441Z'),\n" +
            "('ETH-USD','sell',2615.58,'4.4E-4','2022-03-08T18:04:03.289441Z'),\n" +
            "('ETH-USD','sell',2615.58,'4.4E-4','2022-03-08T18:04:03.289441Z'),\n" +
            "('ETH-USD','sell',2615.58,'0.001','2022-03-08T18:04:03.289441Z'),\n" +
            "('ETH-USD','sell',2615.58,'9.075600000000001E-4','2022-03-08T18:04:03.289441Z'),\n" +
            "('ETH-USD','sell',2615.56,'1.67','2022-03-08T18:04:03.289441Z'),\n" +
            "('ETH-USD','buy',2615.41,'0.001','2022-03-08T18:04:03.837294Z'),\n" +
            "('ETH-USD','buy',2615.41,'0.001','2022-03-08T18:04:03.837294Z'),\n" +
            "('ETH-USD','buy',2615.42,'0.001','2022-03-08T18:04:03.837294Z'),\n" +
            "('ETH-USD','buy',2615.43,'0.003','2022-03-08T18:04:03.837294Z'),\n" +
            "('ETH-USD','buy',2615.8,'4.4E-4','2022-03-08T18:04:03.837294Z'),\n" +
            "('ETH-USD','buy',2615.8,'4.4E-4','2022-03-08T18:04:03.837294Z'),\n" +
            "('ETH-USD','buy',2615.8,'4.4E-4','2022-03-08T18:04:03.837294Z'),\n" +
            "('ETH-USD','buy',2615.8,'4.4E-4','2022-03-08T18:04:03.837294Z'),\n" +
            "('ETH-USD','buy',2615.81,'0.102952','2022-03-08T18:04:03.837294Z');";


    @Test
    public void testVwmaBasic() throws Exception {
        assertMemoryLeak(() -> {
            ddl(DDL);
            insert(INSERT);
            drainWalQueue();
            assertSql("vwma\n" +
                    "2615.663635939613\n", "(select vwma(price, amount) over (partition by symbol) from trades) LIMIT 1");
            // check it is the same as vwap
            assertSql("vwma\n" +
                    "2615.663635939613\n", "\n" +
                    "((select vwma(price, amount) over (partition by symbol) from (select * from trades where symbol = 'ETH-USD' LIMIT 100)) LIMIT 1) \n" +
                    "UNION \n" +
                    "(select vwap(price, amount) as vwma from trades where symbol = 'ETH-USD' LIMIT 100)");
        });
    }
}


